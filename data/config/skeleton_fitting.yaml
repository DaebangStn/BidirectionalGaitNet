# Skeleton Fitting Optimization Configuration

skeleton_fitting:
  # Frame range for optimization
  frame_range:
    start: 0      # 0-based start frame
    end: -1       # -1 = all frames, or specific end frame (inclusive)

  # Marker correspondence: skeleton marker name -> C3D data index/label
  # C3D test.c3d labels for reference:
  # [0] Top.Head  [1] Front.Head  [2] Rear.Head  [3] R.Shoulder  [4] R.Offset
  # [5] R.Elbow   [6] R.Wrist     [7] L.Shoulder [8] L.Elbow     [9] L.Wrist
  # [10] R.ASIS   [11] L.ASIS     [12] V.Sacral  [13] R.Thigh    [14] R.Knee
  # [15] R.Shank  [16] R.Ankle    [17] R.Heel    [18] R.Toe      [19] L.Thigh
  # [20] L.Knee   [21] L.Shank    [22] L.Ankle   [23] L.Heel     [24] L.Toe
  marker_mappings:
    # Pelvis markers
    - {name: 'RASI', data_label: 'R.ASIS'}
    - {name: 'LASI', data_label: 'L.ASIS'}
    - {name: 'VSAC', data_label: 'V.Sacral'}
    # Virtual hip joint centers (computed by Harrington method, indices 25, 26, do not specify by data_label because it is computed automatically)
    - {name: 'R_Hip', data_idx: 25}
    - {name: 'L_Hip', data_idx: 26}

    # FemurR markers
    - {name: 'RTHI', data_label: 'R.Thigh'}
    - {name: 'RKNE_fem', data_label: 'R.Knee'}

    # TibiaR markers
    - {name: 'RKNE_tib', data_label: 'R.Knee'}
    - {name: 'RSHA', data_label: 'R.Shank'}
    - {name: 'RANK_tib', data_label: 'R.Ankle'}

    # TalusR markers
    - {name: 'RANK_tal', data_label: 'R.Ankle'}
    - {name: 'RHEE', data_label: 'R.Heel'}
    - {name: 'R.TO', data_label: 'R.Toe'}

    # FemurL markers
    - {name: 'LTHI', data_label: 'L.Thigh'}
    - {name: 'LKNE_fem', data_label: 'L.Knee'}

    # TibiaL markers
    - {name: 'LKNE_tib', data_label: 'L.Knee'}
    - {name: 'LSHA', data_label: 'L.Shank'}
    - {name: 'LANK_tib', data_label: 'L.Ankle'}

    # TalusL markers
    - {name: 'LANK_tal', data_label: 'L.Ankle'}
    - {name: 'LHEE', data_label: 'L.Heel'}
    - {name: 'L.TO', data_label: 'L.Toe'}

    # Upper body markers
    - {name: 'THEA', data_label: 'Top.Head'}
    - {name: 'FHEA', data_label: 'Front.Head'}
    - {name: 'RHEA', data_label: 'Rear.Head'}
    
    - {name: 'RSHO', data_label: 'R.Shoulder'}
    - {name: 'RSHO_arm', data_label: 'R.Shoulder'}
    - {name: 'RELB_arm', data_label: 'R.Elbow'}
    - {name: 'RELB_farm', data_label: 'R.Elbow'}
    - {name: 'RWRI', data_label: 'R.Wrist'}
    - {name: 'LSHO', data_label: 'L.Shoulder'}
    - {name: 'LSHO_arm', data_label: 'L.Shoulder'}
    - {name: 'LELB_arm', data_label: 'L.Elbow'}
    - {name: 'LELB_farm', data_label: 'L.Elbow'}
    - {name: 'LWRI', data_label: 'L.Wrist'}
    
    - {name: 'ROFF', data_label: 'R.Offset'}

  optimization:
    max_iterations: 100
    convergence_threshold: 1.0e-6
    plot_convergence: false
    lambda_rot: 10.0           # Rotation regularization weight for Ceres optimizer
    interpolate_ratio: 0.5

    # SVD-based optimizer targets (requires 3+ markers)
    target_svd:
      - Pelvis
      - FemurR
      - TibiaR
      - TalusR
      - FemurL
      - TibiaL
      - TalusL
      - Torso
      - Head

    # Ceres-based optimizer targets (handles 2+ markers with regularization)
    target_ceres:
      - ArmR
      - ForeArmR
      - ArmL
      - ForeArmL

    # Revolute axis selection mode for motion skeleton conversion
    # Modes: PCA (always use PCA), FIX (always use XML axis), BLEND (blend based on threshold)
    revolute_axis_mode: XML
    revolute_axis_threshold_low: 5.0    # degrees - below this, use XML axis
    revolute_axis_threshold_high: 10.0   # degrees - above this, use PCA axis (between = blend)

    # Motion skeleton conversion targets (joint names = body node names)
    # Joints listed here will have offset estimation and pose projection applied
    target_motion_joint:
      - Pelvis
      - FemurR
      - TibiaR
      - TalusR
      - FemurL
      - TibiaL
      - TalusL
      - Spine
      - Torso
      - Neck
      - Head
      - ArmR
      - ForeArmR
      - ArmL
      - ForeArmL

  # Inverse Kinematics refinement parameters (DLS + Line Search)
  inverse_kinematics:
    max_iterations: 5          # Maximum IK iterations per frame
    tolerance: 5.0e-3           # Convergence tolerance (meters)
    lambda: 0.05                # DLS damping factor (Levenberg-Marquardt)
    alpha_init: 1.0             # Initial line search step size
    beta: 0.5                   # Line search backtrack factor
    max_line_search: 8          # Maximum line search iterations

    # Arm IK step limits (radians)
    arm_max_twist: 0.5         # Max arm twist step per iteration
    arm_max_elbow: 0.5          # Max elbow angle step per iteration

    # Leg IK step limits (radians)
    leg_max_hip: 0.05           # Max hip rotation step per iteration
    leg_max_knee: 0.05           # Max knee angle step per iteration
