# Skeleton Fitting Optimization Configuration
# Used by C3D_Reader::fitSkeletonMultiFrame()
#
# Marker Mapping Format:
# ======================
# marker_mappings: flat list mapping skeleton marker name â†’ C3D data
#   - {name: 'RASI', data_idx: 10}        # Direct index
#   - {name: 'RASI', data_label: 'R.ASIS'} # Resolved from C3D labels
#
# The bone association is determined from marker XML (default.xml), not here.
# This just maps skeleton marker names to C3D data indices/labels.

skeleton_fitting:
  # Frame range for optimization
  frame_range:
    start: 0      # 0-based start frame
    end: -1       # -1 = all frames, or specific end frame (inclusive)

  # Marker correspondence: skeleton marker name -> C3D data index/label
  # C3D test.c3d labels for reference:
  # [0] Top.Head  [1] Front.Head  [2] Rear.Head  [3] R.Shoulder  [4] R.Offset
  # [5] R.Elbow   [6] R.Wrist     [7] L.Shoulder [8] L.Elbow     [9] L.Wrist
  # [10] R.ASIS   [11] L.ASIS     [12] V.Sacral  [13] R.Thigh    [14] R.Knee
  # [15] R.Shank  [16] R.Ankle    [17] R.Heel    [18] R.Toe      [19] L.Thigh
  # [20] L.Knee   [21] L.Shank    [22] L.Ankle   [23] L.Heel     [24] L.Toe
  marker_mappings:
    # Pelvis markers
    - {name: 'RASI', data_label: 'R.ASIS'}
    - {name: 'LASI', data_label: 'L.ASIS'}
    - {name: 'VSAC', data_label: 'V.Sacral'}
    # Virtual hip joint centers (computed by Harrington method, indices 25, 26, do not specify by data_label because it is computed automatically)
    - {name: 'R_Hip', data_idx: 25}
    - {name: 'L_Hip', data_idx: 26}

    # FemurR markers
    - {name: 'RTHI', data_label: 'R.Thigh'}
    - {name: 'RKNE_fem', data_label: 'R.Knee'}

    # TibiaR markers
    - {name: 'RKNE_tib', data_label: 'R.Knee'}
    - {name: 'RSHA', data_label: 'R.Shank'}
    - {name: 'RANK_tib', data_label: 'R.Ankle'}

    # TalusR markers
    - {name: 'RANK_tal', data_label: 'R.Ankle'}
    - {name: 'RHEE', data_label: 'R.Heel'}
    - {name: 'R.TO', data_label: 'R.Toe'}

    # FemurL markers
    - {name: 'LTHI', data_label: 'L.Thigh'}
    - {name: 'LKNE_fem', data_label: 'L.Knee'}

    # TibiaL markers
    - {name: 'LKNE_tib', data_label: 'L.Knee'}
    - {name: 'LSHA', data_label: 'L.Shank'}
    - {name: 'LANK_tib', data_label: 'L.Ankle'}

    # TalusL markers
    - {name: 'LANK_tal', data_label: 'L.Ankle'}
    - {name: 'LHEE', data_label: 'L.Heel'}
    - {name: 'L.TO', data_label: 'L.Toe'}

    # Upper body markers
    - {name: 'THEA', data_label: 'Top.Head'}
    - {name: 'FHEA', data_label: 'Front.Head'}
    - {name: 'RHEA', data_label: 'Rear.Head'}
    
    - {name: 'RSHO_shoul', data_label: 'R.Shoulder'}
    - {name: 'RSHO_arm', data_label: 'R.Shoulder'}
    - {name: 'RELB_arm', data_label: 'R.Elbow'}
    - {name: 'RELB_farm', data_label: 'R.Elbow'}
    - {name: 'RWRI', data_label: 'R.Wrist'}
    - {name: 'LSHO_shoul', data_label: 'L.Shoulder'}
    - {name: 'LSHO_arm', data_label: 'L.Shoulder'}
    - {name: 'LELB_arm', data_label: 'L.Elbow'}
    - {name: 'LELB_farm', data_label: 'L.Elbow'}
    - {name: 'LWRI', data_label: 'L.Wrist'}
    
    - {name: 'ROFF', data_label: 'R.Offset'}

  optimization:
    max_iterations: 20
    convergence_threshold: 1.0e-6
    plot_convergence: true
    lambda_rot: 10.0           # Rotation regularization weight for Ceres optimizer
    interpolate_ratio: 0.5     # Interpolation ratio for dependent bones (Spine, Neck)
    skel_ratio_bound: 1.5      # Max scale ratio constraint: max(s)/min(s) <= 1.5

    # SVD-based optimizer targets (requires 3+ markers)
    target_svd:
      - Pelvis
      - FemurR
      - TibiaR
      - TalusR
      - FemurL
      - TibiaL
      - TalusL
      - Head

    # Ceres-based optimizer targets (handles 2+ markers with regularization)
    target_ceres:
      - ArmR
      - ForeArmR
      - ArmL
      - ForeArmL
