digraph StreamlitPID {
  rankdir=TB;
  splines=ortho;
  nodesep=0.6;
  ranksep=0.7;
  fontname="Helvetica";
  label=<<font point-size="14"><b>Streamlit App: PID Data Source</b></font>>;
  labelloc=t;

  node [
    shape=box,
    style="rounded,filled",
    fillcolor="white",
    color="gray30",
    fontname="Helvetica",
    fontsize=10,
    margin="0.12,0.08"
  ];

  edge [
    color="gray30",
    penwidth=1.2,
    arrowsize=0.7,
    fontname="Helvetica",
    fontsize=8
  ];

  // ─────────────────────────────────────────────────────────────
  // Cluster: User Selection
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_selection {
    style=filled;
    fillcolor="#E3F2FD";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">User Selection</font>>;

    source_type [label="Source Type\n\"Patient (PID)\"", fillcolor="#BBDEFB"];
    pid_select [label="Patient\nSelectbox"];
    session_select [label="Session\n(pre/post)"];
    h5_select [label="HDF5 File\nSelectbox"];
  }

  // ─────────────────────────────────────────────────────────────
  // Cluster: Data Loading (core/data.py)
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_loading {
    style=filled;
    fillcolor="#F1F8E9";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">Data Loading (core/data.py)</font>>;

    list_pids [label="list_pids()"];
    list_hdf [label="list_hdf_files()"];
    load_hdf5 [label="load_hdf5_data()", fillcolor="#C8E6C9"];
    rm_uri [label="@pid:{pid}/{visit}/\nmotion/{file}", shape=note, fillcolor="#FFF9C4"];
  }

  // ─────────────────────────────────────────────────────────────
  // Cluster: Data Structure
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_data {
    style=filled;
    fillcolor="#FFF8E1";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">Data Structure (dict)</font>>;

    data_dict [label=<
      <table border="0" cellborder="0" cellspacing="2">
        <tr><td align="left"><b>marker_error_free_data</b></td><td align="left">(frames x markers)</td></tr>
        <tr><td align="left"><b>marker_error_motion_data</b></td><td align="left">(frames x markers)</td></tr>
        <tr><td align="left"><b>marker_error_free_mean</b></td><td align="left">(frames,)</td></tr>
        <tr><td align="left"><b>marker_error_motion_mean</b></td><td align="left">(frames,)</td></tr>
        <tr><td align="left"><b>marker_names</b></td><td align="left">[str, ...]</td></tr>
        <tr><td align="left"><b>frame_rate, num_frames</b></td><td align="left">metadata</td></tr>
      </table>
    >, shape=record, fillcolor="white"];
  }

  // ─────────────────────────────────────────────────────────────
  // Cluster: View Routing
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_routing {
    style=filled;
    fillcolor="#F3E5F5";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">View Routing (config/app.yaml)</font>>;

    view_filter [label="Filter by\nsources: [\"pid\"]"];
    load_view [label="load_view()\n(registry.py)"];
  }

  // ─────────────────────────────────────────────────────────────
  // Cluster: Available Views
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_views {
    style=filled;
    fillcolor="#ECEFF1";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">PID Views</font>>;

    view_heatmap [label="Marker Error\nHeatmap", fillcolor="#E1BEE7"];
    view_timeseries [label="Mean Error\nTimeseries", fillcolor="#E1BEE7"];
  }

  // ─────────────────────────────────────────────────────────────
  // Edges: Main Flow
  // ─────────────────────────────────────────────────────────────
  source_type -> pid_select [penwidth=2.0, color="black"];
  pid_select -> session_select [penwidth=2.0, color="black"];
  session_select -> h5_select [penwidth=2.0, color="black"];

  list_pids -> pid_select [style=dashed, color="gray50", label="options"];
  list_hdf -> h5_select [style=dashed, color="gray50", label="options"];

  pid_select -> list_hdf [penwidth=1.5, color="gray40"];
  h5_select -> rm_uri [penwidth=2.0, color="black"];
  rm_uri -> load_hdf5 [penwidth=2.0, color="black"];
  load_hdf5 -> data_dict [penwidth=2.5, color="black", label="returns"];

  data_dict -> view_filter [penwidth=2.0, color="black"];
  view_filter -> load_view [penwidth=2.0, color="black"];
  load_view -> view_heatmap [penwidth=2.0, color="black"];
  load_view -> view_timeseries [penwidth=2.0, color="black"];

  // Rank alignment
  {rank=same; pid_select; list_pids;}
  {rank=same; h5_select; list_hdf;}
  {rank=same; view_heatmap; view_timeseries;}
}
