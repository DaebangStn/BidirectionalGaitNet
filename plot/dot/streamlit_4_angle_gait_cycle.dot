digraph AngleGaitCycle {
  rankdir=LR;
  splines=ortho;
  nodesep=0.5;
  ranksep=0.8;
  fontname="Helvetica";
  label=<<font point-size="14"><b>View: Joint Angles vs Gait Cycle</b></font>>;
  labelloc=t;

  node [
    shape=box,
    style="rounded,filled",
    fillcolor="white",
    color="gray30",
    fontname="Helvetica",
    fontsize=10,
    margin="0.12,0.08"
  ];

  edge [
    color="gray30",
    penwidth=1.2,
    arrowsize=0.7,
    fontname="Helvetica",
    fontsize=8
  ];

  // ─────────────────────────────────────────────────────────────
  // Cluster: Controls (render_controls)
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_controls {
    style=filled;
    fillcolor="#E3F2FD";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">render_controls()</font>>;

    ctrl_metrics [label="metrics\n(multi-checkbox)"];
    ctrl_mode [label="mode\n[Aggregate|Single|\nPre-computed]"];
    ctrl_cycle [label="cycle_idx\n(slider)"];
    ctrl_yrange [label="y_ranges\n(per-metric)"];
    ctrl_info [label="show_info\n(checkbox)"];
  }

  // ─────────────────────────────────────────────────────────────
  // METRIC_DEFINITIONS
  // ─────────────────────────────────────────────────────────────
  metric_defs [label=<
    <table border="0" cellborder="0" cellspacing="2">
      <tr><td colspan="2"><b>METRIC_DEFINITIONS</b></td></tr>
      <tr><td align="left">hip_l:</td><td align="left">angle.hip_l</td></tr>
      <tr><td align="left">knee_l:</td><td align="left">angle.knee_l</td></tr>
      <tr><td align="left">ankle_l:</td><td align="left">angle.ankle_l</td></tr>
      <tr><td align="left">com_x:</td><td align="left">sway.com_x</td></tr>
      <tr><td align="left">...</td><td align="left">...</td></tr>
    </table>
  >, shape=none, fillcolor="#FFF9C4"];

  // ─────────────────────────────────────────────────────────────
  // Controls Dict
  // ─────────────────────────────────────────────────────────────
  controls_dict [label=<
    <table border="0" cellborder="0" cellspacing="2">
      <tr><td colspan="2"><b>controls dict</b></td></tr>
      <tr><td align="left">metrics:</td><td align="left">["hip_l", ...]</td></tr>
      <tr><td align="left">mode:</td><td align="left">"Aggregate"</td></tr>
      <tr><td align="left">cycle_idx:</td><td align="left">0</td></tr>
      <tr><td align="left">y_ranges:</td><td align="left">{metric: (min,max)}</td></tr>
    </table>
  >, shape=none, fillcolor="#FFF9C4"];

  // ─────────────────────────────────────────────────────────────
  // Cluster: Data Input
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_data {
    style=filled;
    fillcolor="#F1F8E9";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">Data Input</font>>;

    data_cycles [label="cycles[i].angle\ncycles[i].sway"];
    data_phase [label="cycles[i].phase"];
    data_avg [label="averaged\n(optional)"];
  }

  // ─────────────────────────────────────────────────────────────
  // Cluster: Rendering Pipeline
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_render {
    style=filled;
    fillcolor="#F3E5F5";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">render_plot()</font>>;

    branch [label="mode\nbranch", shape=diamond, fillcolor="#E1BEE7"];
    interp [label="Interpolate\nto 500 frames"];
    aggregate [label="Aggregate\nmean +/- std"];
    single [label="Single\nCycle"];
    precomp [label="Pre-computed\nAverage"];
  }

  // ─────────────────────────────────────────────────────────────
  // Cluster: Output
  // ─────────────────────────────────────────────────────────────
  subgraph cluster_output {
    style=filled;
    fillcolor="#ECEFF1";
    color="gray70";
    penwidth=0.5;
    label=<<font point-size="9">matplotlib Output</font>>;

    output [label=<
      <table border="0" cellborder="0" cellspacing="2">
        <tr><td><b>1 x N Subplots</b></td></tr>
        <tr><td>X: gait phase %</td></tr>
        <tr><td>Y: angle (deg) / sway (m)</td></tr>
        <tr><td>N = len(metrics)</td></tr>
      </table>
    >, shape=none, fillcolor="#CFD8DC"];
  }

  // ─────────────────────────────────────────────────────────────
  // Edges
  // ─────────────────────────────────────────────────────────────
  ctrl_metrics -> controls_dict [penwidth=1.5];
  ctrl_mode -> controls_dict [penwidth=1.5];
  ctrl_cycle -> controls_dict [penwidth=1.5];
  ctrl_yrange -> controls_dict [penwidth=1.5];
  ctrl_info -> controls_dict [penwidth=1.5];

  metric_defs -> ctrl_metrics [style=dashed, color="gray50", label="options"];

  controls_dict -> branch [penwidth=2.0, color="black"];
  data_cycles -> interp [penwidth=2.0, color="black"];
  data_phase -> interp [penwidth=2.0, color="black"];
  interp -> branch [penwidth=2.0, color="black"];
  data_avg -> precomp [penwidth=1.5, color="gray50"];

  branch -> aggregate [label="\"Aggregate\"", penwidth=1.5];
  branch -> single [label="\"Single\"", penwidth=1.5];
  branch -> precomp [label="\"Pre-comp\"", penwidth=1.5];

  aggregate -> output [penwidth=2.0, color="black"];
  single -> output [penwidth=2.0, color="black"];
  precomp -> output [penwidth=2.0, color="black"];

  // Rank alignment
  {rank=same; ctrl_metrics; ctrl_mode; ctrl_cycle; ctrl_yrange; ctrl_info;}
  {rank=same; data_cycles; data_phase; data_avg;}
  {rank=same; aggregate; single; precomp;}
}
