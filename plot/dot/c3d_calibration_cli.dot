// Static & Dynamic Calibration Algorithms
// Static vertical (left) | Dynamic horizontal stages (right, A→B→C)
digraph c3d_calibration_algorithms {
    rankdir=TB;
    splines=ortho;
    nodesep=0.3;
    ranksep=0.3;
    fontname="Helvetica";
    newrank=true;
    size="16,9!";
    ratio="fill";

    node [
        shape=box, style="rounded,filled", fillcolor="white", color="gray30",
        fontname="Helvetica", fontsize=10, margin="0.12,0.08"
    ];
    edge [
        color="gray30", penwidth=1.2, arrowsize=0.7,
        fontname="Helvetica", fontsize=8
    ];

    // ============================================================
    // STATIC (left column, vertical)
    // ============================================================
    subgraph cluster_static {
        style=filled; fillcolor="#E3F2FD"; color="#1565C0"; penwidth=1.0;
        label=<<font point-size="10"><b>Static Calibration</b> (single frame)</font>>;

        s_hip [label="Hip Joint Center\nHarrington regression", fillcolor="#BBDEFB"];
        s_svd [label="Bone Fitting\nscale, transformation\n(1 frame, per bone)", fillcolor="#BBDEFB"];
        s_talus [label="Talus Marker Offset\n(find marker height)", fillcolor="#90CAF9"];
        s_marker [label="Marker Offset\ntorso, shank\n(back-project from data)", fillcolor="#BBDEFB"];
        s_result [label="Bone Scale and\nMarker Offset", fillcolor="#BBDEFB"];

        s_hip -> s_svd -> s_talus -> s_marker -> s_result
            [penwidth=2.0, color="#1565C0"];
    }

    // ============================================================
    // DYNAMIC A: Bone Fitting
    // ============================================================
    subgraph cluster_dyn_a {
        style=filled; fillcolor="#FFF3E0"; color="#E65100"; penwidth=1.0;
        label=<<font point-size="9"><b>A:</b> Bone Fitting</font>>;

        d_hip [label="Hip Joint Center\nHarrington regression", fillcolor="#FFE0B2"];
        d_svd [label="Bone Fitting\nscale, transformation\n(all frames, per bone)", fillcolor="#FFE0B2"];
        d_arm [label="Arm Scaling\n(two marker body part)", fillcolor="#FFE0B2"];
        d_dep [label="Dependent Scales\nspine \u2192 torso\nforearm \u2192 hand\n(copy from neighbor)", fillcolor="#FFE0B2"];
        d_sym [label="Symmetry\nEnforcement", fillcolor="#FFE0B2"];

        d_hip -> d_svd -> d_arm -> d_dep -> d_sym
            [penwidth=2.0, color="#E65100"];
    }

    // ============================================================
    // DYNAMIC B: Build skeleton and motion
    // ============================================================
    subgraph cluster_dyn_b {
        style=filled; fillcolor="#E8F5E9"; color="#2E7D32"; penwidth=1.0;
        label=<<font point-size="9"><b>B:</b> Build skeleton and motion</font>>;

        d_rel [label="Relative Transform\n(parent-to-child)", fillcolor="#C8E6C9"];
        d_free [label="Build Free Joint Skeleton\n(rotation for each DOFs)", fillcolor="#C8E6C9"];
        d_offset [label="Joint Offset Estimation\n(least-squares fitting)", fillcolor="#C8E6C9"];
        d_project [label="Project Joint Angles to\nConstrained Skeleton", fillcolor="#C8E6C9"];

        d_rel -> d_free -> d_offset -> d_project
            [penwidth=2.0, color="#2E7D32"];
    }

    // ============================================================
    // DYNAMIC C: IK Refinement
    // ============================================================
    subgraph cluster_dyn_c {
        style=filled; fillcolor="#FFEBEE"; color="#C62828"; penwidth=1.0;
        label=<<font point-size="9"><b>C:</b> IK Refinement</font>>;

        d_foot [label="Foot Lock Detection\nstance phase + blend", fillcolor="#FFCDD2"];
        d_arm_ik [label="Arm IK\n2-link analytic\ntwist limits", fillcolor="#FFCDD2"];
        d_leg_ik [label="Leg IK\nDLS + line search\njoint limits", fillcolor="#FFCDD2"];

        d_foot -> d_arm_ik -> d_leg_ik
            [penwidth=2.0, color="#C62828"];
    }

    // ============================================================
    // Inter-stage flow arrows
    // ============================================================
    d_sym -> d_rel [penwidth=1.8, color="#2E7D32", style=bold];
    d_project -> d_foot [penwidth=1.8, color="#C62828", style=bold];

    // ============================================================
    // Layout alignment
    // ============================================================
    {rank=same; s_hip; d_hip;}
    {rank=same; s_svd; d_svd;}
    {rank=same; s_result; d_sym;}
    {rank=same; d_project; d_foot;}

    // Force left-to-right ordering within rows
    s_hip -> d_hip [style=invis];
    s_result -> d_sym [style=invis];
}
