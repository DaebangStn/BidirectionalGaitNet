# Muscle Personalizer Application Configuration
# NOTE: Window geometry and default_open_panels are in render.yaml

metadata:
  version: "1.0"
  description: "Muscle personalization tool configuration"

# Default paths
paths:
  rom_config_dir: "@data/config/rom"
  hdf_motions_dir: "@data/motions"
  skeleton_default: "@data/skeleton/base.yaml"
  muscle_default: "@data/muscle/base.yaml"
  # skeleton_default: "@data/skeleton/gmfcs3.yaml"
  # Reference character for waypoint optimization (standard/ideal muscle behavior)
  reference_skeleton: "@data/skeleton/base.yaml"
  reference_muscle: "@data/muscle/base.yaml"
  # muscle_groups: "@data/config/muscle_groups.yaml"
  muscle_groups: "@data/config/muscle_groups_detailed.yaml"

# Weight scaling defaults
weight_scaling:
  reference_mass: 50.0    # kg
  default_target: 50.0    # kg

# Waypoint optimization defaults
waypoint_optimization:
  analytical_gradient: false
  fix_origin_insertion: false
  use_normalized_length: true
  max_iterations: 500
  num_sampling: 200
  lambda_shape: 1.0
  lambda_length_curve: 0.2
  weight_phase: 1.0      # weight for (min_phase - ref)² + (max_phase - ref)²
  weight_delta: 5.0     # weight for (delta - ref)²
  weight_samples: 1.0    # weight for sample loss at N phase points
  num_phase_samples: 4   # number of evenly-spaced phase points (3 → 0, 0.5, 1.0)
  loss_power: 2          # Power exponent (2=squared, 3=cube)
  parallelism: 32
  max_displacement: 0.2          # Max waypoint displacement (meters)
  max_displacement_origin_insertion: 0.03  # Tighter constraint for origin/insertion
  function_tolerance: 1e-5       # Convergence tolerance on cost function
  gradient_tolerance: 1e-6      # Convergence tolerance on gradient
  parameter_tolerance: 1e-5      # Convergence tolerance on parameters
  adaptive_sample_weight: false  # Adaptive weighting based on normalized length

# Contracture estimation defaults
contracture_estimation:
  max_iterations: 100
  min_ratio: 0.5
  max_ratio: 1.2
  solver_verbose: false
  lambda_ratio_reg: 0.0    # Penalize (ratio - 1.0)^2 (0=disabled)
  lambda_torque_reg: 0.0  # Penalize passive torque magnitude (0=disabled)
  outer_iterations: 1      # Outer iterations for biarticular convergence (1=single pass)
  grid_search:
    begin: 0.5
    end: 1.3
    interval: 0.025

  # Grid search mapping: maps ROM trials (list) to muscle groups (list)
  # For joint multi-group optimization, multiple trials search multiple groups simultaneously
  # NOTE: Each muscle group appears in exactly ONE mapping (no duplicates)
  grid_search_mapping:
    # ============ ANKLE ============
    # Ankle dorsiflexion - tests plantarflexor tightness
    # k0 = knee extended (stretches gastrocnemius), k90 = knee flexed (isolates soleus)
    - trials: [dorsi_k0_L, dorsi_k90_L]
      groups: [plantarflexor_l, knee_ankle_biart_l]
    - trials: [dorsi_k0_R, dorsi_k90_R]
      groups: [plantarflexor_r, knee_ankle_biart_r]

    # Ankle plantarflexion - tests dorsiflexor tightness
    - trials: [plantar_L]
      groups: [dorsiflexor_l]
    - trials: [plantar_R]
      groups: [dorsiflexor_r]

    # ============ HIP FLEXION/EXTENSION ============
    # Staheli extension test (Thomas test) - tests hip flexor tightness
    # Includes iliopsoas (monoarticular) and rectus femoris, sartorius (biarticular)
    - trials: [staheliExtension_L]
      groups: [hip_flexor_l]
    - trials: [staheliExtension_R]
      groups: [hip_flexor_r]

    # ============ HIP ROTATION ============
    # Internal rotation tests lateral rotator tightness + medial rotators (abductors)
    - trials: [intRot_L]
      groups: [hip_lateral_rotator_l, hip_abductor_l]
    - trials: [intRot_R]
      groups: [hip_lateral_rotator_r, hip_abductor_r]

    # ============ HIP ABDUCTION/ADDUCTION/EXTERNAL ROTATION ============
    # Hip abductors (Gluteus Medius, Minimus, TFL) also provide medial rotation
    # Joint search: add (abductor tightness) + extRot (medial rotator tightness)
    - trials: [add_L, extRot_L]
      groups: [hip_abductor_l]
    - trials: [add_R, extRot_R]
      groups: [hip_abductor_r]

    # Hip abduction - tests hip adductor tightness
    # k0 = knee extended (stretches gracilis), k90 = knee flexed (isolates monoarticular)
    - trials: [abd_k0_L, abd_k90_L]
      groups: [hip_adductor_l]
      # groups: [hip_adductor_l, gracilis_biart_l]
    - trials: [abd_k0_R, abd_k90_R]
      groups: [hip_adductor_r]
      # groups: [hip_adductor_r, gracilis_biart_r]

    # ============ KNEE ============
    # Popliteal angle - tests hamstring tightness (with hip flexed 90°)
    # Primarily stretches biarticular hamstrings, also monoarticular knee flexors
    - trials: [popliteal_L]
      groups: [hamstring_biart_l, knee_flexor_l]
    - trials: [popliteal_R]
      groups: [hamstring_biart_r, knee_flexor_r]

    # ============ UNMAPPED GROUPS ============
    # The following groups have no dedicated ROM test:
    # - hip_extensor_l/r (gluteus maximus) - could add hip flexion ROM test
    # - knee_extensor_l/r (vasti) - could add knee flexion ROM test

  # Default ROM trials to select (empty = none selected)
  default_rom_trials:
    - "dorsi_k0_L"
    - "dorsi_k0_R"
    - "dorsi_k90_L"
    - "dorsi_k90_R"
    # - "plantar_L"
    # - "plantar_R"
    - "popliteal_L"
    - "popliteal_L_relax"
    - "popliteal_R"
    - "popliteal_R_relax"
    - "staheliExtension_L"
    - "staheliExtension_R"
    - "add_L"
    - "add_R"
    - "abd_k0_L"
    - "abd_k0_R"
    # - "abd_k90_L"
    # - "abd_k90_R"
    # - "intRot_L"
    # - "intRot_R"
    # - "extRot_L"
    # - "extRot_R"

# Muscle visualization
visualization:
  min_color_value: 0.6
  max_color_value: 1.3
