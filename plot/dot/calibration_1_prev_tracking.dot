// Previous Calibration + Tracking Pipeline
// Original implementation using mFreeCharacter + mMotionCharacter
digraph prev_calibration_tracking {
    rankdir=TB;
    splines=ortho;
    nodesep=0.5;
    ranksep=0.6;
    fontname="Helvetica";
    newrank=true;

    node [
        shape=box,
        style="rounded,filled",
        fillcolor="white",
        color="gray30",
        fontname="Helvetica",
        fontsize=10,
        margin="0.15,0.10"
    ];

    edge [
        color="gray30",
        penwidth=1.2,
        arrowsize=0.7,
        fontname="Helvetica",
        fontsize=8
    ];

    // === TITLE ===
    labelloc="t";
    label=<<font point-size="12"><b>Previous Calibration + Tracking Pipeline</b></font>>;

    // === INPUT ===
    subgraph cluster_input {
        style=filled;
        fillcolor="gray95";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Input</font>>;

        c3d_file [label="Dynamic C3D File\n(walk01-Dynamic.c3d)", fillcolor="#E3F2FD"];
        skel_xml [label="Skeleton XML\n(base_v2.xml)", fillcolor="#FFF8E1"];
        marker_xml [label="Marker XML\n(default.xml)", fillcolor="#FFF8E1"];
        config_yaml [label="skeleton_fitting.yaml\n(population averages)", fillcolor="#FFF8E1"];
    }

    // === CHARACTERS ===
    subgraph cluster_characters {
        style=filled;
        fillcolor="#E8F5E9";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Character Skeletons</font>>;

        free_char [label="mFreeCharacter\n(free joints skeleton)\n126 DOFs", fillcolor="#C8E6C9"];
        motion_char [label="mMotionCharacter\n(articulated skeleton)\n50 DOFs", fillcolor="#A5D6A7"];
    }

    // === STAGE 1: BONE FITTING (mFreeCharacter) ===
    subgraph cluster_bone_fitting {
        style=filled;
        fillcolor="#E3F2FD";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 1: Bone Fitting (mFreeCharacter)</font>>;

        harrington [label="Harrington Hip\nJoint Centers", fillcolor="#BBDEFB"];
        svd_fit [label="SVD Bone Fitting\n(Pelvis, Femur, Tibia,\nTalus, Torso, Head)", fillcolor="#BBDEFB"];
        ceres_fit [label="Ceres Arm Fitting\n(Arm, ForeArm)", fillcolor="#BBDEFB"];
        symmetry [label="Symmetry\nEnforcement", fillcolor="#90CAF9"];

        harrington -> svd_fit [penwidth=2.0, color=black];
        svd_fit -> symmetry [penwidth=2.0, color=black];
        ceres_fit -> symmetry [penwidth=2.0, color=black];
    }

    // === STAGE 2: FREE POSE BUILDING ===
    subgraph cluster_free_pose {
        style=filled;
        fillcolor="#FFF3E0";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 2: Free Pose Building</font>>;

        build_pose [label="buildFramePose()\nfrom mBoneR_frames, mBoneT_frames", fillcolor="#FFE0B2"];
        free_poses [label="Free Poses\n[K frames]", shape=ellipse, fillcolor="white"];

        build_pose -> free_poses [penwidth=2.0, color=black];
    }

    // === STAGE 3: MOTION CONVERSION (mMotionCharacter) ===
    subgraph cluster_motion_conv {
        style=filled;
        fillcolor="#F3E5F5";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 3: Motion Conversion (mMotionCharacter)</font>>;

        estimate_offset [label="estimateJointOffsets()\nleast-squares fitting", fillcolor="#E1BEE7"];
        project_pose [label="projectPoseToMotion()\narticulated IK", fillcolor="#CE93D8"];
        motion_poses [label="Motion Poses\n[K frames]", shape=ellipse, fillcolor="white"];

        estimate_offset -> project_pose [penwidth=2.0, color=black];
        project_pose -> motion_poses [penwidth=2.0, color=black];
    }

    // === STAGE 4: IK REFINEMENT ===
    subgraph cluster_ik {
        style=filled;
        fillcolor="#FCE4EC";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 4: IK Refinement (Optional)</font>>;

        arm_ik [label="refineArmIK()\nDLS + Line Search", fillcolor="#F8BBD9"];
        leg_ik [label="refineLegIK()\nDLS + Line Search", fillcolor="#F8BBD9"];
    }

    // === OUTPUT ===
    subgraph cluster_output {
        style=filled;
        fillcolor="gray95";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Output</font>>;

        bone_scales [label="Bone Scales\n(anisotropic S)", fillcolor="#C8E6C9"];
        joint_offsets [label="Joint Offsets\n(from least-squares)", fillcolor="#C8E6C9"];
        final_motion [label="Motion Sequence\n(articulated poses)", fillcolor="#A5D6A7"];
    }

    // === MAIN FLOW ===
    c3d_file -> harrington [penwidth=2.5, color=black];
    skel_xml -> free_char [penwidth=1.5, color=gray50];
    skel_xml -> motion_char [penwidth=1.5, color=gray50];
    marker_xml -> free_char [penwidth=1.5, color=gray50, style=dashed];
    marker_xml -> motion_char [penwidth=1.5, color=gray50, style=dashed];
    config_yaml -> svd_fit [penwidth=1.0, color=gray50, style=dashed];

    free_char -> svd_fit [penwidth=2.0, color="#4CAF50", label="bone-by-bone"];
    free_char -> ceres_fit [penwidth=2.0, color="#4CAF50"];

    symmetry -> build_pose [penwidth=2.0, color=black];
    free_poses -> estimate_offset [penwidth=2.0, color=black];

    motion_char -> estimate_offset [penwidth=2.0, color="#9C27B0", label="articulated"];
    motion_char -> project_pose [penwidth=2.0, color="#9C27B0"];

    motion_poses -> arm_ik [penwidth=1.5, color=gray50, style=dashed];
    motion_poses -> leg_ik [penwidth=1.5, color=gray50, style=dashed];

    // Output flows
    symmetry -> bone_scales [penwidth=1.5, color="#4CAF50", style=dashed];
    estimate_offset -> joint_offsets [penwidth=1.5, color="#9C27B0", style=dashed];
    motion_poses -> final_motion [penwidth=2.0, color=black];

    // === LIMITATION BOX ===
    subgraph cluster_limitation {
        style=filled;
        fillcolor="#FFEBEE";
        color="#EF5350";
        penwidth=1.0;
        label=<<font point-size="8" color="#C62828">Limitation</font>>;

        limitation [label="Population-average marker offsets\n(THI, Shank, Heel, Toe)\nNo medial markers for constraint",
                   shape=note, fillcolor="#FFCDD2", fontsize=9];
    }

    // Rank alignment
    {rank=same; c3d_file; skel_xml; marker_xml; config_yaml;}
    {rank=same; free_char; motion_char;}
    {rank=same; bone_scales; joint_offsets; final_motion;}
}
