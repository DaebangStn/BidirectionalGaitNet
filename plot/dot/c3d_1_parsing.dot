// C3D Parsing and Preprocessing (Stage 1 Detail)
// File parsing, marker resolution, and backward walking correction
digraph c3d_parsing {
    rankdir=TB;
    splines=ortho;
    nodesep=0.5;
    ranksep=0.6;
    fontname="Helvetica";
    newrank=true;

    node [
        shape=box,
        style="rounded,filled",
        fillcolor="white",
        color="gray30",
        fontname="Helvetica",
        fontsize=10,
        margin="0.15,0.10"
    ];

    edge [
        color="gray30",
        penwidth=1.2,
        arrowsize=0.7,
        fontname="Helvetica",
        fontsize=8
    ];

    // === INPUT FILES ===
    subgraph cluster_input {
        style=filled;
        fillcolor="gray95";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Input Files</font>>;

        c3d_file [label=".c3d File\n(mocap data)", fillcolor="#E3F2FD"];
        yaml_config [label="skeleton_fitting.yaml\n(marker mappings)", fillcolor="#FFF8E1"];
        marker_xml [label="marker.xml\n(skeleton offsets)", fillcolor="#FFF8E1"];
    }

    // === STEP 0: CONFIG LOADING ===
    subgraph cluster_config {
        style=filled;
        fillcolor="#FFF8E1";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Step 0: Load Configuration</font>>;

        load_config [label="loadSkeletonFittingConfig", fillcolor="#FFE082"];
        config_output [label="mFittingConfig\nmarker_mappings\ntarget_svd/ceres", shape=ellipse, fillcolor="white"];

        load_config -> config_output [penwidth=1.5, color=black];
    }

    // === STEP 1: PARSE C3D ===
    subgraph cluster_parse {
        style=filled;
        fillcolor="#E8F5E9";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Step 1: Parse C3D File</font>>;

        parse_c3d [label="parseC3DFile\n(ezc3d library)", fillcolor="#C8E6C9"];
        c3d_data [label="C3D object\nmMarkers[frame][marker]\nframe_rate, labels", shape=ellipse, fillcolor="white"];

        parse_c3d -> c3d_data [penwidth=1.5, color=black];
    }

    // === STEP 2: RESOLVE MARKERS ===
    subgraph cluster_resolve {
        style=filled;
        fillcolor="#E3F2FD";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Step 2: Resolve Marker References</font>>;

        set_labels [label="mResolver.setC3DLabels\n(c3d labels)"];
        set_markerset [label="mResolver.setMarkerSet\n(skeleton markers)"];
        resolve_all [label="resolveMarkerReferences", fillcolor="#BBDEFB"];
        resolved [label="MarkerReference\nname -> dataIndex\nname -> offset, boneName", shape=ellipse, fillcolor="white"];

        set_labels -> resolve_all [penwidth=1.5, color=black];
        set_markerset -> resolve_all [penwidth=1.5, color=black];
        resolve_all -> resolved [penwidth=1.5, color=black];
    }

    // === STEP 3: BACKWARD CORRECTION ===
    subgraph cluster_backward {
        style=filled;
        fillcolor="#F3E5F5";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Step 3: Backward Walking Correction</font>>;

        detect_backward [label="detectAndCorrect\nBackwardWalking", fillcolor="#E1BEE7"];
        correct_markers [label="Marker swap\nLASI <-> RASI etc.", shape=ellipse, fillcolor="white"];

        detect_backward -> correct_markers [penwidth=1.5, color=black];
    }

    // === STEP 4: FRAME RANGE ===
    subgraph cluster_range {
        style=filled;
        fillcolor="#FFF3E0";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Step 4: Compute Frame Range</font>>;

        compute_range [label="mFitFrameStart\nmFitFrameEnd\nfrom config"];
    }

    // === OUTPUT ===
    subgraph cluster_output {
        style=filled;
        fillcolor="gray95";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Output</font>>;

        ready_data [label="Ready for Calibration\nmCurrentC3D\nmFittingConfig\nresolved markers", fillcolor="#C8E6C9"];
    }

    // === MAIN FLOW ===
    c3d_file -> parse_c3d [penwidth=2.5, color=black];
    yaml_config -> load_config [penwidth=2.5, color=black];
    marker_xml -> set_markerset [penwidth=1.5, color=gray50];

    config_output -> resolve_all [penwidth=1.5, color=gray50, style=dashed];
    c3d_data -> set_labels [penwidth=2.5, color=black];
    c3d_data -> detect_backward [penwidth=2.5, color=black];
    resolved -> ready_data [penwidth=2.0, color=black];
    correct_markers -> compute_range [penwidth=2.5, color=black];
    config_output -> compute_range [penwidth=1.0, color=gray50, style=dashed];
    compute_range -> ready_data [penwidth=2.5, color=black];

    // === MARKER RESOLUTION DETAIL ===
    subgraph cluster_resolve_algo {
        style=filled;
        fillcolor="#FAFAFA";
        color="gray80";
        penwidth=0.3;
        label=<<font point-size="7" color="gray50">Marker Resolution</font>>;

        mr1 [label="1. Build label->index map\nfrom C3D labels", fontsize=8, fillcolor="white"];
        mr2 [label="2. Build name->info map\nfrom mMarkerSet (XML)", fontsize=8, fillcolor="white"];
        mr3 [label="3. For each config mapping:\nresolve data_label -> dataIndex\nresolve name -> offset, boneName", fontsize=8, fillcolor="white"];

        mr1 -> mr2 [penwidth=0.8, color=gray60];
        mr2 -> mr3 [penwidth=0.8, color=gray60];
    }

    // === BACKWARD DETECTION DETAIL ===
    subgraph cluster_backward_algo {
        style=filled;
        fillcolor="#FAFAFA";
        color="gray80";
        penwidth=0.3;
        label=<<font point-size="7" color="gray50">Backward Walking Detection</font>>;

        bw1 [label="1. Compute mean SACR\nand mean ASI midpoint", fontsize=8, fillcolor="white"];
        bw2 [label="2. Forward vec = ASI - SACR", fontsize=8, fillcolor="white"];
        bw3 [label="3. If forward.z < 0:\nswap L/R markers", fontsize=8, fillcolor="white"];

        bw1 -> bw2 [penwidth=0.8, color=gray60];
        bw2 -> bw3 [penwidth=0.8, color=gray60];
    }

    // Rank alignment
    {rank=same; c3d_file; yaml_config; marker_xml;}
    {rank=same; set_labels; set_markerset;}
    {rank=same; mr1; bw1;}
}
