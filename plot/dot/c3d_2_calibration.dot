// C3D Calibration Pipeline (Stage 2 Detail)
// calibrateSkeleton: Multi-stage anisotropic bone scale fitting
digraph c3d_calibration {
    rankdir=TB;
    splines=ortho;
    nodesep=0.5;
    ranksep=0.6;
    fontname="Helvetica";
    newrank=true;

    node [
        shape=box,
        style="rounded,filled",
        fillcolor="white",
        color="gray30",
        fontname="Helvetica",
        fontsize=10,
        margin="0.15,0.10"
    ];

    edge [
        color="gray30",
        penwidth=1.2,
        arrowsize=0.7,
        fontname="Helvetica",
        fontsize=8
    ];

    // === INPUT ===
    subgraph cluster_input {
        style=filled;
        fillcolor="gray95";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Input</font>>;

        markers [label="C3D Markers\n[K frames][N markers]", fillcolor="#E3F2FD"];
        marker_map [label="MarkerReference\n(offset + dataIndex)", fillcolor="#E3F2FD"];
        config [label="SkeletonFittingConfig\ntarget_svd, target_ceres", fillcolor="#FFF8E1"];
    }

    // === STAGE 1: HIP JOINT CENTERS ===
    subgraph cluster_hjc {
        style=filled;
        fillcolor="#E8F5E9";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 1: Hip Joint Centers</font>>;

        hjc_input [label="RASI, LASI, SACR\nmarkers", shape=ellipse, fillcolor="white"];
        harrington [label="Harrington\nRegression", fillcolor="#C8E6C9"];
        hjc_output [label="R_Hip, L_Hip\n(idx 25, 26)", shape=ellipse, fillcolor="white"];

        hjc_input -> harrington [penwidth=2.0, color=black];
        harrington -> hjc_output [penwidth=2.0, color=black];
    }

    // === STAGE 2a: SVD FITTING ===
    subgraph cluster_svd {
        style=filled;
        fillcolor="#E3F2FD";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 2a: SVD Fitting (3+ markers)</font>>;

        svd_bones [label="Pelvis, FemurR/L,\nTibiaR/L, TalusR/L,\nTorso, Head"];
        svd_opt [label="optimizeBoneScale\n(SVD)", fillcolor="#BBDEFB"];
        svd_output [label="S (scale)\nR, t (per-frame)", shape=ellipse, fillcolor="white"];

        svd_bones -> svd_opt [penwidth=2.0, color=black];
        svd_opt -> svd_output [penwidth=2.0, color=black];
    }

    // === STAGE 2b: CERES FITTING ===
    subgraph cluster_ceres {
        style=filled;
        fillcolor="#FFF3E0";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 2b: Ceres Fitting (2+ markers)</font>>;

        ceres_bones [label="ArmR/L,\nForeArmR/L"];
        ceres_opt [label="optimizeBoneScale\nCeres", fillcolor="#FFE0B2"];
        ceres_output [label="S (scale)\nR, t (per-frame)", shape=ellipse, fillcolor="white"];

        ceres_bones -> ceres_opt [penwidth=2.0, color=black];
        ceres_opt -> ceres_output [penwidth=2.0, color=black];
    }

    // === STAGE 2c: DEPENDENT BONES ===
    subgraph cluster_dependent {
        style=filled;
        fillcolor="#F3E5F5";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Stage 2c: Dependent Bones</font>>;

        copy_scales [label="copyDependentScales\nHand=ForeArm, Neck=Head"];
        interpolate [label="interpolateDependent\nSpine, Neck"];
    }

    // === OUTPUT ===
    subgraph cluster_output {
        style=filled;
        fillcolor="gray95";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="8">Output</font>>;

        bone_r [label="mBoneR_frames\n{bone -> R[t]}", fillcolor="#C8E6C9"];
        bone_t [label="mBoneT_frames\n{bone -> t[t]}", fillcolor="#C8E6C9"];
        skel_info [label="mSkelInfos\n(anisotropic scales)", fillcolor="#C8E6C9"];
    }

    // === MAIN FLOW ===
    markers -> hjc_input [penwidth=2.5, color=black];
    marker_map -> svd_opt [penwidth=1.5, color=gray50];
    marker_map -> ceres_opt [penwidth=1.5, color=gray50];
    config -> svd_bones [penwidth=1.0, color=gray50, style=dashed];
    config -> ceres_bones [penwidth=1.0, color=gray50, style=dashed];

    hjc_output -> svd_opt [penwidth=2.0, color=black, label="augment"];
    svd_output -> copy_scales [penwidth=2.0, color=black];
    ceres_output -> copy_scales [penwidth=2.0, color=black];
    copy_scales -> interpolate [penwidth=2.0, color=black];

    // Output flows
    svd_output -> bone_r [penwidth=1.5, color="#4CAF50", style=dashed];
    svd_output -> bone_t [penwidth=1.5, color="#4CAF50", style=dashed];
    ceres_output -> bone_r [penwidth=1.5, color="#FF9800", style=dashed];
    ceres_output -> bone_t [penwidth=1.5, color="#FF9800", style=dashed];
    interpolate -> skel_info [penwidth=2.0, color=black];

    // === SVD ALGORITHM DETAIL ===
    subgraph cluster_svd_algo {
        style=filled;
        fillcolor="#FAFAFA";
        color="gray80";
        penwidth=0.3;
        label=<<font point-size="7" color="gray50">SVD Algorithm</font>>;

        svd_step1 [label="1. Build q_i\n(local offsets)", fontsize=8, fillcolor="white"];
        svd_step2 [label="2. Alternating:\nfix S, solve R,t\nfix R,t, solve S", fontsize=8, fillcolor="white"];
        svd_step3 [label="3. SVD for R\nLeast-squares for t", fontsize=8, fillcolor="white"];

        svd_step1 -> svd_step2 [penwidth=0.8, color=gray60];
        svd_step2 -> svd_step3 [penwidth=0.8, color=gray60];
    }

    // === HARRINGTON DETAIL ===
    subgraph cluster_harrington_algo {
        style=filled;
        fillcolor="#FAFAFA";
        color="gray80";
        penwidth=0.3;
        label=<<font point-size="7" color="gray50">Harrington Method</font>>;

        h_step1 [label="1. Pelvis coords\nO, e_ML, e_AP, e_SI", fontsize=8, fillcolor="white"];
        h_step2 [label="2. d_ASIS, d_depth\nmeasurements", fontsize=8, fillcolor="white"];
        h_step3 [label="3. Regression\nML, AP, SI offsets", fontsize=8, fillcolor="white"];

        h_step1 -> h_step2 [penwidth=0.8, color=gray60];
        h_step2 -> h_step3 [penwidth=0.8, color=gray60];
    }

    // Rank alignment
    {rank=same; markers; marker_map; config;}
    {rank=same; svd_bones; ceres_bones;}
    {rank=same; svd_output; ceres_output;}
    {rank=same; bone_r; bone_t; skel_info;}
}
