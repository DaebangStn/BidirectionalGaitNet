digraph ppo_hierarchical {
    // Clean base settings
    rankdir=LR;
    splines=ortho;
    nodesep=0.6;
    ranksep=1.0;
    fontname="Helvetica";

    // Default node style
    node [
        shape=box,
        style="rounded,filled",
        fillcolor="white",
        color="gray30",
        fontname="Helvetica",
        fontsize=11,
        margin="0.2,0.15"
    ];

    // Default edge style
    edge [
        color="gray50",
        penwidth=1.0,
        arrowsize=0.8,
        fontname="Helvetica",
        fontsize=9
    ];

    // Backend selection (left zone)
    subgraph cluster_backend {
        style=filled;
        fillcolor="gray95";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="9">Backend Selection</font>>;

        asyncvec [label="AsyncVectorEnv", xlabel=<<font point-size="8">Python MP</font>>];
        batchenv [label="BatchEnv", xlabel=<<font point-size="8">C++ ThreadPool</font>>];
    }

    // Environment (middle zone)
    subgraph cluster_env {
        style=filled;
        fillcolor="#E3F2FD";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="9">C++ Simulation</font>>;

        env [label="Environment", xlabel=<<font point-size="8">C++ sim</font>>];
        musclenn [label="Muscle NN", xlabel=<<font point-size="8">libtorch CPU</font>>];
    }

    // Python learning (right zone)
    subgraph cluster_learning {
        style=filled;
        fillcolor="#F1F8E9";
        color="gray70";
        penwidth=0.5;
        label=<<font point-size="9">Python Learning</font>>;

        ppo [label="PPO", xlabel=<<font point-size="8">PyTorch GPU</font>>];
        agent [label="Agent", xlabel=<<font point-size="8">Actor-Critic</font>>];
        mlearn [label="Muscle Loss", xlabel=<<font point-size="8">MSE</font>>];
        muscle [label="Muscle Net", xlabel=<<font point-size="8">Hierarchical</font>>];
    }

    // Main flow: Backend → Env → PPO → Agent (thick black)
    asyncvec -> env [penwidth=2.5, color=black];
    batchenv -> env [penwidth=2.5, color=black];
    env -> ppo [label="trajectory", penwidth=2.5, color=black, fontsize=10];
    ppo -> agent [penwidth=2.5, color=black];

    // Supporting flows (thin gray)
    env -> musclenn [label="substeps", penwidth=1.0, color="gray60", style=dotted];
    musclenn -> mlearn [penwidth=1.0, color="gray60"];
    mlearn -> muscle [penwidth=1.0, color="gray60"];

    // Weight sync (dashed orange)
    muscle -> musclenn [label="sync", penwidth=1.5, color="orange", style=dashed];

    // Alignment: same rank for parallel components
    {rank=same; asyncvec; batchenv;}
    {rank=same; ppo; mlearn;}
    {rank=same; agent; muscle;}
}
